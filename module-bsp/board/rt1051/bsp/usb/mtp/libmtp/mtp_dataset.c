#include "mtp_responder.h"
#include "mtp_storage.h"
#include "mtp_util.h"

const uint16_t MTP_SUPPORTED_OPERATIONS[] =
{
    MTP_OPERATION_GET_DEVICE_INFO,
    MTP_OPERATION_OPEN_SESSION,
    MTP_OPERATION_CLOSE_SESSION,
    MTP_OPERATION_GET_STORAGE_IDS,
    MTP_OPERATION_GET_STORAGE_INFO,
//    MTP_OPERATION_GET_NUM_OBJECTS,
    MTP_OPERATION_GET_OBJECT_HANDLES,
    MTP_OPERATION_GET_OBJECT_INFO,
    MTP_OPERATION_GET_OBJECT,
//    MTP_OPERATION_GET_THUMB,
    MTP_OPERATION_DELETE_OBJECT,
    MTP_OPERATION_SEND_OBJECT_INFO,
    MTP_OPERATION_SEND_OBJECT,
///    MTP_OPERATION_INITIATE_CAPTURE,
///    MTP_OPERATION_FORMAT_STORE,
//    MTP_OPERATION_RESET_DEVICE,
///    MTP_OPERATION_SELF_TEST,
///    MTP_OPERATION_SET_OBJECT_PROTECTION,
///    MTP_OPERATION_POWER_DOWN,
//    MTP_OPERATION_GET_DEVICE_PROP_DESC,
//    MTP_OPERATION_GET_DEVICE_PROP_VALUE,
//    MTP_OPERATION_SET_DEVICE_PROP_VALUE,
//    MTP_OPERATION_RESET_DEVICE_PROP_VALUE,
///    MTP_OPERATION_TERMINATE_OPEN_CAPTURE,
//    MTP_OPERATION_MOVE_OBJECT,
//    MTP_OPERATION_COPY_OBJECT,
//    MTP_OPERATION_GET_PARTIAL_OBJECT,
///    MTP_OPERATION_INITIATE_OPEN_CAPTURE,
    MTP_OPERATION_GET_OBJECT_PROPS_SUPPORTED,
    MTP_OPERATION_GET_OBJECT_PROP_DESC,
    MTP_OPERATION_GET_OBJECT_PROP_VALUE,
    MTP_OPERATION_SET_OBJECT_PROP_VALUE,
//    MTP_OPERATION_GET_OBJECT_PROP_LIST,
///    MTP_OPERATION_SET_OBJECT_PROP_LIST,
///    MTP_OPERATION_GET_INTERDEPENDENT_PROP_DESC,
///    MTP_OPERATION_SEND_OBJECT_PROP_LIST,
//    MTP_OPERATION_GET_OBJECT_REFERENCES,
//    MTP_OPERATION_SET_OBJECT_REFERENCES,
///    MTP_OPERATION_SKIP,
    // Android extension for direct file IO
//    MTP_OPERATION_GET_PARTIAL_OBJECT_64,
//    MTP_OPERATION_SEND_PARTIAL_OBJECT,
//    MTP_OPERATION_TRUNCATE_OBJECT,
//    MTP_OPERATION_BEGIN_EDIT_OBJECT,
//    MTP_OPERATION_END_EDIT_OBJECT,
};

const uint16_t MTP_SUPPORTED_EVENTS[] =
{
//	MTP_EVENT_UNDEFINED,
	MTP_EVENT_CANCEL_TRANSACTION,
//	MTP_EVENT_OBJECT_ADDED,
//	MTP_EVENT_OBJECT_REMOVED,
//	MTP_EVENT_STORE_ADDED,
//	MTP_EVENT_STORE_REMOVED,
//	MTP_EVENT_DEVICE_PROP_CHANGED,
//	MTP_EVENT_OBJECT_INFO_CHANGED,
//	MTP_EVENT_DEVICE_INFO_CHANGED,
//	MTP_EVENT_REQUEST_OBJECT_TRANSFER,
//	MTP_EVENT_STORE_FULL,
//	MTP_EVENT_DEVICE_RESET,
//	MTP_EVENT_STORAGE_INFO_CHANGED,
//	MTP_EVENT_CAPTURE_COMPLETE,
//	MTP_EVENT_UNREPORTED_STATUS,
//	MTP_EVENT_OBJECT_PROP_CHANGED,
//	MTP_EVENT_OBJECT_PROP_DESC_CHANGED,
//	MTP_EVENT_OBJECT_REFERENCES_CHANGED,
};

const uint16_t MTP_SUPPORTED_DEVICE_PROPERTIES[] =
{
//    MTP_DEVICE_PROPERTY_UNDEFINED,
//    MTP_DEVICE_PROPERTY_BATTERY_LEVEL,
//    MTP_DEVICE_PROPERTY_FUNCTIONAL_MODE,
//    MTP_DEVICE_PROPERTY_IMAGE_SIZE,
//    MTP_DEVICE_PROPERTY_COMPRESSION_SETTING,
//    MTP_DEVICE_PROPERTY_WHITE_BALANCE,
//    MTP_DEVICE_PROPERTY_RGB_GAIN,
//    MTP_DEVICE_PROPERTY_F_NUMBER,
//    MTP_DEVICE_PROPERTY_FOCAL_LENGTH,
//    MTP_DEVICE_PROPERTY_FOCUS_DISTANCE,
//    MTP_DEVICE_PROPERTY_FOCUS_MODE,
//    MTP_DEVICE_PROPERTY_EXPOSURE_METERING_MODE,
//    MTP_DEVICE_PROPERTY_FLASH_MODE,
//    MTP_DEVICE_PROPERTY_EXPOSURE_TIME,
//    MTP_DEVICE_PROPERTY_EXPOSURE_PROGRAM_MODE,
//    MTP_DEVICE_PROPERTY_EXPOSURE_INDEX,
//    MTP_DEVICE_PROPERTY_EXPOSURE_BIAS_COMPENSATION,
//    MTP_DEVICE_PROPERTY_DATETIME,
//    MTP_DEVICE_PROPERTY_CAPTURE_DELAY,
//    MTP_DEVICE_PROPERTY_STILL_CAPTURE_MODE,
//    MTP_DEVICE_PROPERTY_CONTRAST,
//    MTP_DEVICE_PROPERTY_SHARPNESS,
//    MTP_DEVICE_PROPERTY_DIGITAL_ZOOM,
//    MTP_DEVICE_PROPERTY_EFFECT_MODE,
//    MTP_DEVICE_PROPERTY_BURST_NUMBER,
//    MTP_DEVICE_PROPERTY_BURST_INTERVAL,
//    MTP_DEVICE_PROPERTY_TIMELAPSE_NUMBER,
//    MTP_DEVICE_PROPERTY_TIMELAPSE_INTERVAL,
//    MTP_DEVICE_PROPERTY_FOCUS_METERING_MODE,
//    MTP_DEVICE_PROPERTY_UPLOAD_URL,
//    MTP_DEVICE_PROPERTY_ARTIST,
//    MTP_DEVICE_PROPERTY_COPYRIGHT_INFO,
//    MTP_DEVICE_PROPERTY_SYNCHRONIZATION_PARTNER,
//    MTP_DEVICE_PROPERTY_DEVICE_FRIENDLY_NAME,
//    MTP_DEVICE_PROPERTY_VOLUME,
//    MTP_DEVICE_PROPERTY_SUPPORTED_FORMATS_ORDERED,
//    MTP_DEVICE_PROPERTY_DEVICE_ICON,
//    MTP_DEVICE_PROPERTY_PLAYBACK_RATE,
//    MTP_DEVICE_PROPERTY_PLAYBACK_OBJECT,
//    MTP_DEVICE_PROPERTY_PLAYBACK_CONTAINER_INDEX,
//    MTP_DEVICE_PROPERTY_SESSION_INITIATOR_VERSION_INFO,
//    MTP_DEVICE_PROPERTY_PERCEIVED_DEVICE_TYPE,
};

const uint16_t MTP_SUPPORTED_CAPTURE_FORMATS[] =
{
    MTP_FORMAT_UNDEFINED,
//    MTP_FORMAT_ASSOCIATION,
//    MTP_FORMAT_SCRIPT,
//    MTP_FORMAT_EXECUTABLE,
    MTP_FORMAT_TEXT,
//    MTP_FORMAT_HTML,
//    MTP_FORMAT_DPOF,
//    MTP_FORMAT_AIFF,
    MTP_FORMAT_WAV,
//    MTP_FORMAT_MP3,
//    MTP_FORMAT_AVI,
//    MTP_FORMAT_MPEG,
//    MTP_FORMAT_ASF,
//    MTP_FORMAT_DEFINED,
    MTP_FORMAT_EXIF_JPEG,
//    MTP_FORMAT_TIFF_EP,
//    MTP_FORMAT_FLASHPIX,
//    MTP_FORMAT_BMP,
//    MTP_FORMAT_CIFF,
//    MTP_FORMAT_GIF,
//    MTP_FORMAT_JFIF,
//    MTP_FORMAT_CD,
//    MTP_FORMAT_PICT,
//    MTP_FORMAT_PNG,
//    MTP_FORMAT_TIFF,
//    MTP_FORMAT_TIFF_IT,
//    MTP_FORMAT_JP2,
//    MTP_FORMAT_JPX,
//    MTP_FORMAT_DNG,
//    MTP_FORMAT_HEIF,
//    MTP_FORMAT_UNDEFINED_FIRMWARE,
//    MTP_FORMAT_WINDOWS_IMAGE_FORMAT,
//    MTP_FORMAT_UNDEFINED_AUDIO,
//    MTP_FORMAT_WMA,
//    MTP_FORMAT_OGG,
//    MTP_FORMAT_AAC,
//    MTP_FORMAT_AUDIBLE,
//    MTP_FORMAT_FLAC,
//    MTP_FORMAT_UNDEFINED_VIDEO,
//    MTP_FORMAT_WMV,
//    MTP_FORMAT_MP4_CONTAINER,
//    MTP_FORMAT_MP2,
//    MTP_FORMAT_3GP_CONTAINER,
//    MTP_FORMAT_UNDEFINED_COLLECTION,
//    MTP_FORMAT_ABSTRACT_MULTIMEDIA_ALBUM,
//    MTP_FORMAT_ABSTRACT_IMAGE_ALBUM,
//    MTP_FORMAT_ABSTRACT_AUDIO_ALBUM,
//    MTP_FORMAT_ABSTRACT_VIDEO_ALBUM,
//    MTP_FORMAT_ABSTRACT_AV_PLAYLIST,
//    MTP_FORMAT_ABSTRACT_CONTACT_GROUP,
//    MTP_FORMAT_ABSTRACT_MESSAGE_FOLDER,
//    MTP_FORMAT_ABSTRACT_CHAPTERED_PRODUCTION,
//    MTP_FORMAT_ABSTRACT_AUDIO_PLAYLIST,
//    MTP_FORMAT_ABSTRACT_VIDEO_PLAYLIST,
//    MTP_FORMAT_ABSTRACT_MEDIACAST,
//    MTP_FORMAT_WPL_PLAYLIST,
//    MTP_FORMAT_M3U_PLAYLIST,
//    MTP_FORMAT_MPL_PLAYLIST,
//    MTP_FORMAT_ASX_PLAYLIST,
//    MTP_FORMAT_PLS_PLAYLIST,
//    MTP_FORMAT_UNDEFINED_DOCUMENT,
//    MTP_FORMAT_ABSTRACT_DOCUMENT,
//    MTP_FORMAT_XML_DOCUMENT,
//    MTP_FORMAT_MS_WORD_DOCUMENT,
//    MTP_FORMAT_MHT_COMPILED_HTML_DOCUMENT,
//    MTP_FORMAT_MS_EXCEL_SPREADSHEET,
//    MTP_FORMAT_MS_POWERPOINT_PRESENTATION,
//    MTP_FORMAT_UNDEFINED_MESSAGE,
//    MTP_FORMAT_ABSTRACT_MESSSAGE,
//    MTP_FORMAT_UNDEFINED_CONTACT,
//    MTP_FORMAT_ABSTRACT_CONTACT,
//    MTP_FORMAT_VCARD_2,
};

const uint16_t MTP_SUPPORTED_PLAYBACK_FORMATS[] =
{
    MTP_FORMAT_UNDEFINED,
//    MTP_FORMAT_ASSOCIATION,
//    MTP_FORMAT_SCRIPT,
//    MTP_FORMAT_EXECUTABLE,
    MTP_FORMAT_TEXT,
//    MTP_FORMAT_HTML,
//    MTP_FORMAT_DPOF,
//    MTP_FORMAT_AIFF,
    MTP_FORMAT_WAV,
//    MTP_FORMAT_MP3,
//    MTP_FORMAT_AVI,
//    MTP_FORMAT_MPEG,
//    MTP_FORMAT_ASF,
//    MTP_FORMAT_DEFINED,
    MTP_FORMAT_EXIF_JPEG,
//    MTP_FORMAT_TIFF_EP,
//    MTP_FORMAT_FLASHPIX,
//    MTP_FORMAT_BMP,
//    MTP_FORMAT_CIFF,
//    MTP_FORMAT_GIF,
//    MTP_FORMAT_JFIF,
//    MTP_FORMAT_CD,
//    MTP_FORMAT_PICT,
//    MTP_FORMAT_PNG,
//    MTP_FORMAT_TIFF,
//    MTP_FORMAT_TIFF_IT,
//    MTP_FORMAT_JP2,
//    MTP_FORMAT_JPX,
//    MTP_FORMAT_DNG,
//    MTP_FORMAT_HEIF,
//    MTP_FORMAT_UNDEFINED_FIRMWARE,
//    MTP_FORMAT_WINDOWS_IMAGE_FORMAT,
//    MTP_FORMAT_UNDEFINED_AUDIO,
//    MTP_FORMAT_WMA,
//    MTP_FORMAT_OGG,
//    MTP_FORMAT_AAC,
//    MTP_FORMAT_AUDIBLE,
//    MTP_FORMAT_FLAC,
//    MTP_FORMAT_UNDEFINED_VIDEO,
//    MTP_FORMAT_WMV,
//    MTP_FORMAT_MP4_CONTAINER,
//    MTP_FORMAT_MP2,
//    MTP_FORMAT_3GP_CONTAINER,
//    MTP_FORMAT_UNDEFINED_COLLECTION,
//    MTP_FORMAT_ABSTRACT_MULTIMEDIA_ALBUM,
//    MTP_FORMAT_ABSTRACT_IMAGE_ALBUM,
//    MTP_FORMAT_ABSTRACT_AUDIO_ALBUM,
//    MTP_FORMAT_ABSTRACT_VIDEO_ALBUM,
//    MTP_FORMAT_ABSTRACT_AV_PLAYLIST,
//    MTP_FORMAT_ABSTRACT_CONTACT_GROUP,
//    MTP_FORMAT_ABSTRACT_MESSAGE_FOLDER,
//    MTP_FORMAT_ABSTRACT_CHAPTERED_PRODUCTION,
//    MTP_FORMAT_ABSTRACT_AUDIO_PLAYLIST,
//    MTP_FORMAT_ABSTRACT_VIDEO_PLAYLIST,
//    MTP_FORMAT_ABSTRACT_MEDIACAST,
//    MTP_FORMAT_WPL_PLAYLIST,
//    MTP_FORMAT_M3U_PLAYLIST,
//    MTP_FORMAT_MPL_PLAYLIST,
//    MTP_FORMAT_ASX_PLAYLIST,
//    MTP_FORMAT_PLS_PLAYLIST,
//    MTP_FORMAT_UNDEFINED_DOCUMENT,
//    MTP_FORMAT_ABSTRACT_DOCUMENT,
//    MTP_FORMAT_XML_DOCUMENT,
//    MTP_FORMAT_MS_WORD_DOCUMENT,
//    MTP_FORMAT_MHT_COMPILED_HTML_DOCUMENT,
//    MTP_FORMAT_MS_EXCEL_SPREADSHEET,
//    MTP_FORMAT_MS_POWERPOINT_PRESENTATION,
//    MTP_FORMAT_UNDEFINED_MESSAGE,
//    MTP_FORMAT_ABSTRACT_MESSSAGE,
//    MTP_FORMAT_UNDEFINED_CONTACT,
//    MTP_FORMAT_ABSTRACT_CONTACT,
//    MTP_FORMAT_VCARD_2,
};

bool is_format_code_supported(uint16_t format_code)
{
    int i;
    if (format_code == 0 || format_code == 0xffff)
        return true;

    for (i = 0; i < sizeof(MTP_SUPPORTED_PLAYBACK_FORMATS)/sizeof(uint16_t); i++)
        if (MTP_SUPPORTED_PLAYBACK_FORMATS[i] == format_code)
            return true;
    return false;
}

uint32_t serialize_device_info(const mtp_device_info_t *info, uint8_t *data)
{
    uint32_t length = 0;
    length += put_16(data, 100u);
    length += put_32(data + length, 6u);
    length += put_16(data + length, 100u);
    length += put_string(data + length, "microsoft.com: 1.0;");
    length += put_16(data + length, 0u);
    length += put_array(data + length, MTP_SUPPORTED_OPERATIONS,
                sizeof(MTP_SUPPORTED_OPERATIONS)/sizeof(uint16_t), sizeof(uint16_t));
    length += put_array(data + length, MTP_SUPPORTED_EVENTS,
                sizeof(MTP_SUPPORTED_EVENTS)/sizeof(uint16_t), sizeof(uint16_t));
    length += put_array(data + length, MTP_SUPPORTED_DEVICE_PROPERTIES,
                sizeof(MTP_SUPPORTED_DEVICE_PROPERTIES)/sizeof(uint16_t), sizeof(uint16_t));
    length += put_array(data + length, MTP_SUPPORTED_CAPTURE_FORMATS,
                sizeof(MTP_SUPPORTED_CAPTURE_FORMATS)/sizeof(uint16_t), sizeof(uint16_t));
    length += put_array(data + length, MTP_SUPPORTED_PLAYBACK_FORMATS,
                sizeof(MTP_SUPPORTED_PLAYBACK_FORMATS)/sizeof(uint16_t), sizeof(uint16_t));
    length += put_string(data + length, info->manufacturer);
    length += put_string(data + length, info->model);
    length += put_string(data + length, info->version);
    length += put_string(data + length, info->serial);
    return length;

}
